swagger: '2.0'
info:
  description: EW REST API for SSO - Account Service - Management of Accounts (Customers)
  version: '1.0'
  termsOfService: 'http://www.karumien.com/terms/'
  contact:
    email: info@karumien.com
  title: Account Service
  license:
    name: Apache 2.0
    url: 'http://www.apache.org/licenses/LICENSE-2.0.html'
basePath: /api/v1/iam
schemes:
  - http
paths:
  /accounts:
    get:
      summary: "Get known Accounts"
      operationId: "getAccounts"
      responses:
        '200':
          description: Successfully found Accounts
          schema:
            type: array
            items:
              $ref: '#/definitions/AccountInfo'
    post:
      summary: Create Account 
      description: Create Account in target SSO
      operationId: createAccount
      parameters:
        - in: body
          name: Account
          description: The Account to create
          schema:
            $ref: '#/definitions/AccountInfo'
      responses:
        '201':
          description: Successfully created
          schema:
            $ref: '#/definitions/AccountInfo'
        '409':
          description: Account already exists (conflict accountNumber)
  /accounts/{accountNumber}:
    get:
      summary: "Get detail of the given Account"
      description: "Method returns detail information about Account."
      operationId: "getAccount"
      parameters:
        - in: path
          name: accountNumber
          description: Filtering by Account CRM ID
          required: true
          type: string       
      responses:
        '200':
          description: Successfully returned Account's info
          schema:
            $ref: '#/definitions/AccountInfo'
        '410':
          description: Account not found
    delete:
      summary: "Remove existing Account"
      operationId: "deleteAccount"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account CRM ID
          required: true
          type: string       
      responses:
        '200':
          description: Successfully removed existing Account
        '410':
          description: Account not found
  /accounts/{accountNumber}/modules:
    get:
      summary: "Get Active Modules on Account"
      operationId: "getAccountModules"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account CRM ID
          required: true
          type: string   
      responses:
        '200':
          description: Account's activated modules
          schema:
            type: array
            items:
              $ref: '#/definitions/ModuleInfo'
        '410':
          description: Account not found
    put:
      summary: "Activate Modules on Account"
      operationId: "activateAccountModules"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account CRM ID
          required: true
          type: string       
        - in: body
          name: modules
          description: List of Module's ID to activate
          schema:
            type: array
            items:
              type: string                    
      responses:
        '202':
          description: Successfully Activated Modules on Account
        '410':
          description: Account not found
    delete:
      summary: "Deactivate Modules on Account"
      operationId: "deactivateAccountModules"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account CRM ID
          required: true
          type: string       
        - in: body
          name: modules
          description: List of Module's ID to activate
          schema:
            type: array
            items:
              type: string                    
      responses:
        '204':
          description: Successfully deactivated Modules on Account
        '410':
          description: Account not found
  /accounts/{accountNumber}/modules/{moduleId}:
    get:
      summary: "Get Active Module on Account"
      operationId: "getAccountModule"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account CRM ID
          required: true
          type: string   
        - name: moduleId
          in: path
          description: Filtering by Module ID
          required: true
          type: string   
      responses:
        '200':
          description: Module is active on Account
        '410':
          description: Account or Module not found
        '422':
          description: Module Unprocessable entity
    put:
      summary: "Activate Module on Account"
      operationId: "activateAccountModule"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account CRM ID
          required: true
          type: string       
        - name: moduleId
          in: path
          description: Filtering by Module ID
          required: true
          type: string    
      responses:
        '202':
          description: Successfully activated Module on Account
        '410':
          description: Account not found
        '422':
          description: Module Unprocessable entity
    delete:
      summary: "Deactivate Module on Account"
      operationId: "deactivateAccountModule"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account CRM ID
          required: true
          type: string       
        - name: moduleId
          in: path
          description: Filtering by Module ID
          required: true
          type: string    
      responses:
        '204':
          description: Successfully deactivated Module on Account
        '410':
          description: Account not found
        '422':
          description: Module not deactivated
  /accounts/{accountNumber}/roles:
    get:
      summary: "Get Active Roles on Account"
      operationId: "getAccountRoles"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account CRM ID
          required: true
          type: string   
      responses:
        '200':
          description: Account's activated roles
          schema:
            type: array
            items:
              $ref: '#/definitions/RoleInfo'
        '410':
          description: Account Not Found
  /accounts/{accountNumber}/identities:
    post:
      summary: Create Identity
      description: Create Identity in target SSO
      operationId: createAccountIdentity
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account CRM ID
          required: true
          type: string       
        - in: body
          name: identity
          description: The Identity to create
          schema:
            $ref: '#/definitions/IdentityInfo'
      responses:
        '201':
          description: Successfully created
          schema:
            $ref: '#/definitions/IdentityInfo'            
        '409':
          description: Identity already exists (conflict username/contactNumber/nav4Id)
    get:
      summary: Return all Identities registered for Account
      operationId: getAccountIdentities
      parameters:
        - in: path
          name: accountNumber
          description: Filtering by Account CRM ID
          required: true
          type: string
        - in: query
          name : roleId
          type: string
          description: Filtered by roleId
          required: false
        - in: query
          name: contactNumbers
          required: false
          description: CRM Contacts IDs
          type: array
          collectionFormat: csv
          items:
            type: string
      responses:
        '200':
          description: Successfully returned Identities
          schema:
            type: array            
            items:
              $ref: '#/definitions/IdentityInfo'
        '410':
          description: Account not found
  /accounts/{accountNumber}/identities/{contactNumber}:
    get:
      summary: "Get detail of the given Identity"
      description: "Method returns detail information about Identity."
      operationId: getAccountIdentity
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM Account Number
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM Contact Number
          required: true
          type: string    
      responses:
        '200':
          description: Successfully returned Identity's info
          schema:
            $ref: '#/definitions/IdentityInfo'
        '409':
          description: Duplicate Identity with same CRM Contact Number
        '410':
          description: Identity or Account Not Found
    put:
      summary: Update Identity
      operationId: updateAccountIdentity
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM Account Number
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM Contact Number
          required: true
          type: string  
        - name: identity
          in: body
          description: The Identity to update
          schema:
            $ref: '#/definitions/IdentityInfo'
            example:
              lastName: Novak
              firstName: Karel
              username: KajaN
              email: KajaN@eurowag.com
      responses:
        '202':
          description: Successfully updated
          schema:
            $ref: '#/definitions/IdentityInfo'
        '409':
          description: Conflict in username/CRM Contact Number/Navision 4 ID
        '410':
          description: Identity or Account not found
    delete:
      summary: "Remove existing Identity"
      operationId: deleteAccountIdentity
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM ID
          required: true
          type: string    
      responses:
        '200':
          description: Successfully removed existing Identity
        '409':
          description: Duplicate Identity with same CRM ContactNumber
        '410':
          description: Identity or Account not found
  /accounts/{accountNumber}/identities/{contactNumber}/state:
    get:
      summary: "Get state of the given Identity"
      operationId: getIdentityState
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM ID
          required: true
          type: string    
      responses:
        '200':
          description: Successfully returned Identity's info
          schema:
            $ref: '#/definitions/IdentityState'
        '409':
          description: Duplicate Identity with same CRM Contact Number
  /accounts/{accountNumber}/identities/roles:
    get:
      summary: "Get detail of the given Identity"
      operationId: getAccountIdentitiesRoles
      parameters:
        - in: path
          name: accountNumber
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - in: query
          name: contactNumbers
          required: false
          description: CRM Contacts IDs
          type: array
          collectionFormat: csv
          items:
            type: string
      responses:
        '200':
          description: Successfully returned Identity's Roles
          schema:
            type: array
            items:
              $ref: '#/definitions/IdentityRoleInfo'
        '410':
          description: Identity or Account not found  
  /accounts/{accountNumber}/identities/{contactNumber}/rights:
    get:
      summary: "Get Identity's Rights Ids"
      operationId: getAccountIdentityRightIds
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM ID
          required: true
          type: string       
      responses:
        '200':
          description: Successfully returned Identity's Roles
          schema:
            type: array
            items:
              type: string
        '410':
          description: Identity or Account not found
  /accounts/{accountNumber}/identities/{contactNumber}/roles:
    get:
      summary: "Get Identity's Roles Ids"
      operationId: getAccountIdentityRoleIds
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM ID
          required: true
          type: string       
      responses:
        '200':
          description: Successfully returned Identity's Roles
          schema:
            type: array
            items:
              type: string
        '410':
          description: Identity or Account not found
    patch:
      summary: "Assign only new roles on Identity"
      operationId: assignAccountIdentityRoles
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM ID
          required: true
          type: string   
        - in: body
          name: roles
          description: List of Roles's ID to deactivate
          schema:
            type: array
            items:
              type: string  
      responses:
        '202':
          description: Successfully added roles to Identity
        '410':
          description: Identity or Account not found
    put:
      summary: "Update roles on Identity"
      operationId: updateAccountIdentityRoles
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM ID
          required: true
          type: string   
        - in: body
          name: roles
          description: List of Roles's ID to activate on Identity
          schema:
            type: array
            items:
              type: string  
      responses:
        '202':
          description: Successfully updated roles on Identity
        '410':
          description: Identity or Account not found
    delete:
      summary: "Unassign roles on Identity"
      operationId: unassignAccountIdentityRoles
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM ID
          required: true
          type: string   
        - in: body
          name: roles
          description: List of Roles's ID to deactivate on Identity
          schema:
            type: array
            items:
              type: string  
      responses:
        '204':
          description: Successfully removed roles of Identity
        '410':
          description: Identity or Account not found
  /accounts/{accountNumber}/identities/{contactNumber}/roles/{roleId}:
    get:
      summary: "Get assigned Roles on Identity"
      operationId: "getAccountIdentityRole"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity CRM ID
          required: true
          type: string   
        - name: roleId
          in: path
          description: Filtering by Role ID
          required: true
          type: string  
      responses:
        '200':
          description: Role is assigned to Identity
        '410':
          description: Identity or Account not found
        '422':
          description: Role not assigned
    put:
      summary: "Assign Role to Identity"
      operationId: "assignAccountIdentityRole"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity CRM ID
          required: true
          type: string       
        - name: roleId
          in: path
          description: Filtering by Role ID
          required: true
          type: string    
      responses:
        '202':
          description: Successfully assigned Role on Identity
        '410':
          description: Identity or Account not found
        '422':
          description: Role for Identity not assigned      
    delete:
      summary: "Remove Role on Identity"
      operationId: "unassignAccountIdentityRole"
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity CRM ID
          required: true
          type: string       
        - name: roleId
          in: path
          description: Filtering by Identity ID
          required: true
          type: string    
      responses:
        '202':
          description: Successfully unassigned Role from Identity
        '410':
          description: Identity or Account not found
        '422':
          description: Role not unassigned
  /accounts/{accountNumber}/hierarchy:
    get:
      summary: Hierarchy definition for Account - modules and right groups (translated, filtered by activated services)
      operationId: getAccountHierarchy
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account CRM ID
          required: true
          type: string
      responses:
        '200':
          description: Successfully returned Identities
          schema:
            type: array            
            items:
              $ref: '#/definitions/ModuleInfo'
        '410':
          description: Account not found  
  /accounts/{accountNumber}/identities/{contactNumber}/credentials:
    get:
      summary: "Check if credentials exists"
      operationId: hasIdentityCredentials
      parameters:
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM Contact Number
          required: true
          type: string       
      responses:
        '200':
          description: Identity has credentials
        '409':
          description: Duplicate Identity with same CRM Contact Number
        '410':
          description: Identity or Credentials Not Found
    post:
      summary: "Add Account Identity credentials"
      description: "Method to create Identity credentials for given customer"
      operationId: createIdentityCredentials
      parameters:
        - name: accountNumber
          in: path
          description: Filtering by Account unique CRM ID
          required: true
          type: string
        - name: contactNumber
          in: path
          description: Filtering by Identity unique CRM ID
          required: true
          type: string       
        - in: body
          name: credentials
          description: The Credentials for Identity to create/change
          schema:
            $ref: '#/definitions/Credentials'
      responses:
        '201':
          description: "Identity creadentials has been created or reset"
        '410':
          description: Identity or Account not found
        '422':
          description: "Can't create Identity's credentials - Error Codes for Attributes: #/definitions/ErrorDataCodeCredentials"
          schema:
            $ref: '#/definitions/ErrorMessage'
  /accounts/exists:
    get:
      summary: "Check if exist Identity by specified attributes"
      operationId: exists
      parameters:
        - in: query
          name: compRegNo
          description: Account existency check by Company Registration Number
          required: false
          type: string 
        - in: query
          name: accountNumber
          description: Account existency check by CRM Account Number
          required: false
          type: string 
      responses:
        '200':
          description: Found Identity specified by filter
        '406':
          description: Empty search criteria is not allowed
        '410':
          description: Account specified by filter not found
  /accounts/search:
    get:
      summary: "Search Account by specified attributes"
      operationId: search
      parameters:
        - in: query
          name: accountNumber
          type: string
          required: false
        - in: query
          name: compRegNo
          type: string
          required: false
        - in: query
          name: name
          type: string
          required: false
        - in: query
          name: contactEmail
          type: string
          required: false
        - in: query
          name: note
          required: false
          type: string 
      responses:
        '200':
          description: Return Accounts specified by filter
          schema:
            type: array
            items:
              $ref: '#/definitions/AccountInfo'
        '410':
          description: Accounts specified by filter not found
        '406':
          description: Empty search criteria is not allowed
  /accounts/onboarding:
    get:
      summary: Onboarding process - source data
      operationId: getOnboardingExport
      parameters:
        - in: body
          name: contactNumbers
          description: The contactNumbers to import
          required: true
          schema:
            type: array
            items:
              type: string
      responses:
        '200':
          description: Account's activated roles
          schema:
            type: array
            items:
              $ref: '#/definitions/OnBoardingInfo'
        '410':
          description: No Identity Found
    post:
      summary: Onboarding process import
      operationId: onboarding
      parameters:
        - in: body
          name: onBoardingInfos
          description: The Account/Identities/Roles to import
          required: true
          schema:
            type: array
            items:
              $ref: '#/definitions/OnBoardingInfo'
      responses:
        '201':
          description: Successfully imported / updated
          schema:
            type: array
            items:
              $ref: '#/definitions/IdentityInfo'       
definitions:
  IdentityState:
    type: string
    enum: [NOT_EXISTS, CREATED, CREDENTIALS_CREATED, AFTER_FIRST_LOGIN, FULL_ACTIVE]
  OnBoardingInfo:
    type: object
    description: "Basic information about Identity"
    properties:
      account:
        $ref: '#/definitions/AccountInfo' 
      identity:
        $ref: '#/definitions/IdentityInfo'
      credentials:
        $ref: '#/definitions/Credentials'
      note:
        type: string
        description: "Notes"
        maxLength: 200
      roles:
        type: array
        items: 
          type: string
      overwriteAccount:
        type: boolean
        default: false
      overwriteIdentity:
        type: boolean
        default: false
      overwriteRoles:
        type: boolean
        default: false
  IdentityInfo:
    type: object
    description: "Basic information about Identity"
#    required:
#      - accountNumber
#      - contactNumber
    properties:
      identityId:
        type: string
        description: Identity's ID 
      accountNumber:
        type: string
        description: Identity's CRM Account ID
      contactNumber:
        type: string
        description: Identity's Unique ID 
      nav4Id:
        type: string
        description: Identity's Unique NAV4 ID 
      lastName:
        type: string
        description: "Last name/ surname of the Identity"
        maxLength: 50
      firstName:
        type: string
        description: "First name of the Identity"
        maxLength: 50
      username:
        type: string
        description: "Unique username"
        maxLength: 50
      email:
        type: string
        description: "Primary email used primary for password reset"
        maxLength: 100
      emailVerified:
        type: boolean
        description: "Verified status of itentity email"
      phone:
        type: string
        description: "Phone used primary for OTP"
        maxLength: 30
      note:
        type: string
        description: "Notes"
        maxLength: 200
      state:
        $ref: "#/definitions/IdentityState"
      locale:
        type: string
        description: "User's default Locale"
        maxLength: 50  
      binaryRights:
        type: string
        description: "User's rights"
    example:
      identityId: fe29248c-f3aa-4310-8fcf-91eacdd324xx
      accountNumber: 31034
      contactNumber: c31034
      lastName: Novak
      firstName: Karel
      email: KajaN@eurowag.com
      emailVerified: true
  IdentityRoleInfo:
    type: object
    description: "Basic information Identity Roles"
    required:
      - accountNumber
      - contactNumber
    properties:
      accountNumber:
        type: string
        description: Identity's CRM Account ID
      contactNumber:
        type: string
        description: Identity's Unique ID 
      nav4Id:
        type: string
        description: Identity's Unique NAV4 ID 
      roles:
        type: array
        items:
          type: string
  AccountInfo:
    type: object
    description: "Basic information about Account"
    required:
      - accountNumber
      - name
    properties:
      accountNumber:
        type: string
        description: Account CRM ID 
      name:
        type: string
        description: "Account Name"
        maxLength: 100
      compRegNo:
        type: string
        maxLength: 20
        description: Account Registration Number
      contactEmail:
        type: string
        description: "Contact Email"
        maxLength: 200
      note:
        type: string
        description: "Notes"
        maxLength: 200
    example:
      accountNumber: 31034
      name: Some AUTODOPRAVA, s.r.o.
      compRegNo: 6484605
      contactEmail: info@doprava.cz
  ModuleInfo:
    type: object
    description: "Basic information about Module"
    required:
      - moduleId
    properties:
      moduleId:
        type: string
        example: "FINANCE"
        maxLength: 40
      name:
        type: string
        description: Name of group
      translation:
        type: string
        description: Translated name of group
      businessPriority:
        type: integer
        description: Order by priority (1 is highest priority/first)      
      groups:
        type: array
        items:
          $ref: "#/definitions/RightGroup"
  RightGroup:
    type: object
    description: Rigth's logical group
    properties:
      groupId:
        type: string
        description: unique prefix ie. FINANCE_TRANSACTION
      name:
        type: string
        description: Name of group
      translation:
        type: string
        description: Translated name of group
      serviceId:
        type: string
        example: "SERVICE_TLM01"
        maxLength: 40    
        description: Filtered by buyed service by account
      businessPriority:
        type: integer
        description: Order by priority (1 is highest priority/first)
  RoleInfo:
    type: object
    description: "Basic information about Role"
    required:
      - roleId
    properties:
      roleId:
        type: string
        description: "Unique Role ID (Role Name)"
        maxLength: 50
      description:
        type: string
        description: "Role description"
        maxLength: 255
      accountNumber:
        type: string
        description: Custom role for account
      translation:
        type: string
        description: "Role translation"
        maxLength: 255
      roles:
        type: array
        items:
          type: string
      rights:
        type: array
        items:
          type: string
  Credentials:
    type: object
    description: "Object for setting of Identity credential"
    properties:
      username:
        type: string
        description: "Unique username"
        maxLength: 50
      password:
        type: string
        maxLength: 50
      temporary:
        type: boolean
        description: "Temporary - need reset after first login"
  ErrorData:
    type: object
    description: EW ErrorMessage model data
    required:
    - code
    properties:
      code:
        type: string
        description: ie. invalid-phone-number-format
        maxLength: 50
      attribute: 
        type: string
        maxLength: 250
        description: ie. phoneNumberPrimary
      description:
        type: string
        maxLength: 1000
        description: ie. Invalid phone number format. Valid is XXX XXX XXX
      data:
        type: object
  ErrorCode:
    type: string
    description: Master Error Code
    enum:
      - CLIENT_ERROR
  ErrorMessage:
    type: object
    description: EW ErrorMessage model
    required:
    - errno
    - errcode
    properties:
      errno: 
        type: integer
        default: -1
      errcode: 
        $ref: "#/definitions/ErrorCode"
      errmsg: 
        type: string
        maxLength: 250
        description: Optional error message
      errdata:
        type: array
        items:
          $ref: "#/definitions/ErrorData"